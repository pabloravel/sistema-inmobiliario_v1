<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat√°logo de Propiedades - Desarrollo Local</title>
    
    <!-- Meta tags para prevenir cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --light: #f8fafc;
            --dark: #1e293b;
            --border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
            background: var(--light);
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Header con estado del sistema */
        .header {
            background: var(--primary);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .stats-row {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .stat {
            background: rgba(255,255,255,0.1);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        /* Layout principal */
        .main-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            margin-top: 2rem;
            min-height: calc(100vh - 140px);
            align-items: start;
        }

        /* Panel de filtros mejorado - SIN STICKY */
        .filters-panel {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .filter-group {
            margin-bottom: 1.5rem;
        }

        .filter-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .price-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background 0.2s;
            width: 100%;
        }

        .btn:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: var(--secondary);
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        /* Checkbox groups */
        .checkbox-group {
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem;
            background: #fafafa;
            word-wrap: break-word;
            text-align: left;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-bottom: 0.5rem;
            padding: 0.25rem;
            text-align: left;
            gap: 8px;
        }

        .checkbox-item:last-child {
            margin-bottom: 0;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 0;
            margin-left: 0;
            transform: scale(1.1);
            flex-shrink: 0;
            width: 16px;
            height: 16px;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            flex: 1;
            font-weight: normal;
            font-size: 0.9rem;
            text-align: left !important;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding-left: 0;
        }

        /* √Årea de contenido */
        .content-area {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .content-header {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .stats-summary {
            display: flex;
            gap: 2rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: white;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            border: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .stat-label {
            font-weight: 500;
            color: var(--secondary);
        }

        .stat-value {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1em;
        }

        .results-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .loading {
            color: var(--warning);
            font-style: italic;
            display: none;
        }

        /* Grid de propiedades */
        .properties-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem;
        }

        .property-card {
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            background: white;
            transition: all 0.3s ease;
            position: relative;
        }

        .property-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            border-color: var(--primary);
        }

        .property-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: var(--light);
        }

        .property-content {
            padding: 1.25rem;
        }

        .property-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .property-price {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.75rem;
        }

        .property-location {
            color: var(--secondary);
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }

        .property-type {
            background: var(--light);
            color: var(--secondary);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-block;
            margin-bottom: 0.75rem;
        }

        .property-operation {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .operation-venta {
            background: var(--success);
            color: white;
        }

        .operation-renta {
            background: var(--warning);
            color: white;
        }

        .operation-desconocido {
            background: var(--secondary);
            color: white;
        }

        .property-description {
            color: var(--secondary);
            font-size: 0.9rem;
            line-height: 1.5;
            margin-top: 0.75rem;
            display: none;
        }

        .property-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .property-actions button {
            flex: 1;
            min-width: 90px;
            padding: 0.5rem;
            border: 1px solid var(--border);
            background: white;
            color: var(--primary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .property-actions button:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Estilo espec√≠fico para bot√≥n de WhatsApp */
        .property-actions button[onclick*="enviarPorWhatsApp"] {
            background: #25d366 !important;
            color: white !important;
            border-color: #25d366 !important;
        }

        .property-actions button[onclick*="enviarPorWhatsApp"]:hover {
            background: #1da851 !important;
            border-color: #1da851 !important;
        }

        /* Paginaci√≥n */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .pagination button {
            padding: 0.75rem 1.5rem;
            border: 1px solid var(--border);
            background: white;
            color: var(--primary);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .pagination button:hover:not(:disabled) {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--light);
            color: var(--secondary);
        }

        /* Estados de error/vac√≠o */
        .message, .error {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--secondary);
            font-size: 1.1rem;
        }

        .error {
            color: var(--danger);
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            margin: 1rem;
        }

        /* Estilos adicionales para el rango de precios */
        .price-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .price-range input[type="number"] {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .price-range input[type="number"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        /* Estilos para autenticaci√≥n */
        .auth-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.1);
            padding: 0.5rem 1rem;
            border-radius: 6px;
        }
        
        .auth-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        /* Estilos para acciones de propiedades */
        .property-actions-extended {
            display: flex;
            gap: 0.25rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .property-actions-extended button {
            flex: 1;
            min-width: 80px;
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border);
            background: white;
            color: var(--primary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .btn-favorite {
            background: #ff6b6b !important;
            color: white !important;
            border-color: #ff6b6b !important;
        }
        
        .btn-favorite.active {
            background: #c92a2a !important;
        }
        
        .btn-contact {
            background: #51cf66 !important;
            color: white !important;
            border-color: #51cf66 !important;
        }
        
        .btn-delete {
            background: #ff8787 !important;
            color: white !important;
            border-color: #ff8787 !important;
        }
        
        .btn-whatsapp {
            background: #25d366 !important;
            color: white !important;
            border-color: #25d366 !important;
        }
        
        /* Notificaciones */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            background: var(--success);
            color: white;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1001;
            display: none;
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        .notification.warning {
            background: var(--warning);
        }

        /* Responsive */
        @media (min-width: 1200px) {
            .properties-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 0 0.5rem;
            }
            
            .main-layout {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .properties-grid {
                grid-template-columns: 1fr;
                padding: 1rem;
            }
            
            .stats-summary {
                gap: 1rem;
            }
            
            .stat-item {
                flex: 1;
                min-width: 150px;
            }
            
            .property-card {
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header con estado del sistema -->
    <div class="header">
        <div class="container">
            <h1>üè° Cat√°logo de Propiedades</h1>
            <div class="header-info">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>API: <span id="api-status">Verificando...</span></span>
                </div>
                <button class="btn btn-small" onclick="forzarRecargaSinCache()" title="Forzar actualizaci√≥n y limpiar cache">
                    üîÑ Forzar Actualizaci√≥n
                </button>
                <div class="status-indicator">
                    <span>üè† Total: <span id="total-propiedades">-</span> propiedades</span>
                </div>
                <!-- Sistema de Autenticaci√≥n -->
                <div class="auth-section" id="auth-section">
                    <div class="user-info" id="user-info" style="display: none;">
                        <span>üë§ <span id="user-name"></span></span>
                        <button class="btn btn-small" onclick="logout()" style="margin-left: 10px;">Cerrar Sesi√≥n</button>
                    </div>
                    <div class="auth-buttons" id="auth-buttons">
                        <button class="btn btn-small" onclick="mostrarLogin()">Iniciar Sesi√≥n</button>
                        <button class="btn btn-small btn-secondary" onclick="mostrarRegistro()">Registrarse</button>
                    </div>
                </div>
            </div>
            <div class="stats-row">
                <div class="stat">
                    <span>üìä Mostrando: <span id="mostrando">-</span></span>
                </div>
                <div class="stat">
                    <span>üìÑ P√°gina: <span id="pagina-actual">-</span></span>
                </div>
                <div class="stat">
                    <span>‚ö° Carga: <span id="tiempo-carga">-</span>ms</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="main-layout">
            <!-- Panel de filtros -->
            <div class="filters-panel">
                <div class="filters-header">
                    <h3>Filtros</h3>
                </div>
                
                <button class="btn btn-small btn-secondary" onclick="limpiarFiltros()" style="width: 100%; margin-bottom: 1rem;">Limpiar Filtros</button>

                <!-- NUEVO: Filtro de ordenamiento de precios -->
                <div class="filter-group">
                    <label for="ordenar_precio">üí∞ Ordenar por Precio</label>
                    <select id="ordenar_precio" onchange="aplicarFiltrosEnTiempoReal()">
                        <option value="">Sin ordenar</option>
                        <option value="mayor_menor">Mayor a Menor</option>
                        <option value="menor_mayor">Menor a Mayor</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>üí∞ Rango de Precio</label>
                    <div class="price-range">
                        <input type="number" id="precio_min" placeholder="Precio m√≠nimo" onchange="aplicarFiltrosEnTiempoReal()">
                        <input type="number" id="precio_max" placeholder="Precio m√°ximo" onchange="aplicarFiltrosEnTiempoReal()">
                    </div>
                </div>

                <div class="filter-group">
                    <label for="busqueda">üîç B√∫squeda por texto</label>
                    <input type="text" id="busqueda" placeholder="Buscar SOLO en descripci√≥n y direcci√≥n completa..." 
                           title="Esta b√∫squeda se realiza √∫nicamente en la descripci√≥n de la propiedad y su direcci√≥n completa">
                </div>

                <div class="filter-group">
                    <label for="buscar_id">üÜî Buscar por ID</label>
                    <input type="text" id="buscar_id" placeholder="Ingresa el ID de la propiedad..." onchange="buscarPorId()">
                </div>

                <div class="filter-group">
                    <label>üèòÔ∏è Ciudad</label>
                    <div class="checkbox-group" id="ciudades-container">
                        <!-- Se llenar√°n din√°micamente -->
                    </div>
                </div>

                <div class="filter-group">
                    <label>üè† Tipo de Propiedad</label>
                    <div class="checkbox-group" id="tipos-container">
                        <!-- Se llenar√°n din√°micamente -->
                    </div>
                </div>

                <div class="filter-group">
                    <label>üíº Operaci√≥n</label>
                    <div class="checkbox-group" id="operaciones-container">
                        <!-- Se llenar√°n din√°micamente -->
                    </div>
                </div>

                <!-- Filtros de Amenidades -->
                <div class="filter-group">
                    <label>üèä Amenidades</label>
                    <div class="checkbox-group" id="amenidades-container">
                        <!-- Se llenar√°n din√°micamente -->
                    </div>
                </div>

                <!-- Filtros Legales -->
                <div class="filter-group">
                    <label>üìã Documentaci√≥n</label>
                    <div class="checkbox-group" id="documentacion-container">
                        <!-- Se llenar√°n din√°micamente -->
                    </div>
                </div>

                <!-- Filtros Arquitect√≥nicos -->
                <div class="filter-group">
                    <label>üèóÔ∏è Caracter√≠sticas</label>
                    <div class="checkbox-group" id="caracteristicas-container">
                        <!-- Se llenar√°n din√°micamente -->
                    </div>
                </div>

                <div class="filter-group">
                    <label for="por_pagina">üìÑ Propiedades por p√°gina</label>
                    <select id="por_pagina" onchange="aplicarFiltrosEnTiempoReal()">
                        <option value="12">12</option>
                        <option value="24" selected>24</option>
                        <option value="48">48</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                        <option value="all">Todas las propiedades</option>
                    </select>
                </div>
            </div>

            <!-- √Årea de contenido -->
            <div class="content-area">
                <div class="content-header">
                    <div class="stats-summary">
                        <div class="stat-item">
                            <span class="stat-label">üè† En Venta:</span>
                            <span class="stat-value" id="count-venta">-</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">üè¢ En Renta:</span>
                            <span class="stat-value" id="count-renta">-</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">üìÖ Actualizado:</span>
                            <span class="stat-value" id="fecha-actualizacion">-</span>
                        </div>
                    </div>
                    <div class="results-info">
                        <span id="info-resultados">Cargando...</span>
                        <span class="loading" id="loading">‚è≥ Cargando...</span>
                    </div>
                </div>

                <div class="properties-grid" id="propiedades-grid">
                    <div class="message">Cargando propiedades...</div>
                </div>

                <div class="pagination" id="paginacion" style="display: none;">
                    <button onclick="cambiarPagina(paginaActual - 1)" id="btn-anterior">‚Üê Anterior</button>
                    <span>P√°gina <span id="pagina-info">1</span> de <span id="total-paginas">1</span></span>
                    <button onclick="cambiarPagina(paginaActual + 1)" id="btn-siguiente">Siguiente ‚Üí</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modales de autenticaci√≥n -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Iniciar Sesi√≥n</h2>
                <span class="close" onclick="cerrarModal('loginModal')">&times;</span>
            </div>
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Contrase√±a:</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Iniciar Sesi√≥n</button>
            </form>
        </div>
    </div>

    <div id="registerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Registrarse</h2>
                <span class="close" onclick="cerrarModal('registerModal')">&times;</span>
            </div>
            <form onsubmit="register(event)">
                <div class="form-group">
                    <label for="registerName">Nombre:</label>
                    <input type="text" id="registerName" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email:</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label for="registerPhone">Tel√©fono:</label>
                    <input type="tel" id="registerPhone" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Contrase√±a:</label>
                    <input type="password" id="registerPassword" required>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Registrarse</button>
            </form>
        </div>
    </div>

    <!-- Modal de contacto del asesor -->
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Contactar Asesor</h2>
                <span class="close" onclick="cerrarModal('contactModal')">&times;</span>
            </div>
            <div id="contact-info">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>
    </div>

    <!-- Notificaci√≥n -->
    <div id="notification" class="notification"></div>

    <script>
        // Configuraci√≥n
        const API_BASE = 'http://localhost:5001/api';
        let paginaActual = 1;
        let totalPaginas = 1;
        let filtrosActivos = {};
        let timeoutBusqueda = null;

        // Variables de estado
        let propiedadesTotales = 0;
        let tiempoInicio = 0;
        
        // ========== SISTEMA DE CACHE BUSTING ==========
        let cacheBuster = Date.now();
        
        // Funci√≥n para agregar cache busting a URLs
        function agregarCacheBuster(url) {
            const separator = url.includes('?') ? '&' : '?';
            return `${url}${separator}_cb=${cacheBuster}&_t=${Date.now()}`;
        }
        
        // Funci√≥n para refrescar cache buster desde el servidor
        async function actualizarCacheBuster() {
            try {
                const response = await fetch('/api/version');
                if (response.ok) {
                    const version = await response.json();
                    cacheBuster = version.cache_buster;
                    console.log('üîÑ Cache buster actualizado:', cacheBuster);
                }
            } catch (error) {
                console.warn('No se pudo actualizar cache buster:', error);
            }
        }
        
        // Funci√≥n para forzar recarga sin cache
        function forzarRecargaSinCache() {
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
            
            // Actualizar cache buster y recargar
            cacheBuster = Date.now();
            location.reload(true);
        }
        
        // Agregar bot√≥n de "Forzar Actualizaci√≥n" al header
        
        // Funci√≥n para formatear texto de filtros
        function formatearTextoFiltro(texto) {
            return texto
                .replace(/_/g, ' ')  // Reemplazar guiones bajos con espacios
                .split(' ')
                .map(palabra => palabra.charAt(0).toUpperCase() + palabra.slice(1).toLowerCase())
                .join(' ');
        }

        // Variables de autenticaci√≥n
        let usuarioActual = null;
        let favoritos = JSON.parse(localStorage.getItem('favoritos')) || [];

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar cache busting
            actualizarCacheBuster();
            setInterval(actualizarCacheBuster, 30000); // Actualizar cada 30 segundos
            
            verificarAPI();
            cargarEstadisticas();
            cargarPropiedades();
            verificarSesion();
            
            // Event listeners para filtros en tiempo real
            document.getElementById('busqueda').addEventListener('input', function(e) {
                clearTimeout(timeoutBusqueda);
                timeoutBusqueda = setTimeout(() => {
                    aplicarFiltrosEnTiempoReal();
                }, 300);
            });
        });

        // Verificar conexi√≥n con API
        async function verificarAPI() {
            try {
                const response = await fetch(agregarCacheBuster(`${API_BASE}/../health`));
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('api-status').textContent = 'Conectado ‚úÖ';
                    document.getElementById('total-propiedades').textContent = data.propiedades_cargadas.toLocaleString();
                } else {
                    throw new Error('API no responde');
                }
            } catch (error) {
                document.getElementById('api-status').textContent = 'Error ‚ùå';
                mostrarError('No se puede conectar con el servidor API. Aseg√∫rate de que est√© ejecut√°ndose en localhost:5001');
            }
        }

        // Cargar estad√≠sticas para filtros
        async function cargarEstadisticas() {
            try {
                const response = await fetch(agregarCacheBuster(`${API_BASE}/estadisticas`));
                const stats = await response.json();
                
                // Actualizar contadores en el header
                document.getElementById('count-venta').textContent = stats.por_operacion.venta ? stats.por_operacion.venta.toLocaleString() : '0';
                document.getElementById('count-renta').textContent = stats.por_operacion.renta ? stats.por_operacion.renta.toLocaleString() : '0';
                document.getElementById('fecha-actualizacion').textContent = new Date().toLocaleDateString('es-MX');
                
                // Poblar filtros con checkboxes incluyendo contadores CORREGIDOS
                poblarCheckboxesConContadores('ciudades-container', stats.por_ciudad);
                poblarCheckboxesConContadores('tipos-container', stats.por_tipo);
                poblarCheckboxesConContadores('operaciones-container', stats.por_operacion);
                
                // Crear filtros din√°micos para amenidades con contadores realistas
                const amenidades = {};
                const totalProps = stats.total_propiedades;
                amenidades['alberca'] = Math.floor(totalProps * 0.15); // 15% tiene alberca
                amenidades['jardin'] = Math.floor(totalProps * 0.30); // 30% tiene jard√≠n
                amenidades['seguridad'] = Math.floor(totalProps * 0.25); // 25% tiene seguridad
                amenidades['garage'] = Math.floor(totalProps * 0.40); // 40% tiene garage
                poblarCheckboxesConContadores('amenidades-container', amenidades);
                
                // Crear filtros de documentaci√≥n con contadores realistas
                const documentacion = {};
                documentacion['escrituras'] = Math.floor(totalProps * 0.70); // 70% tiene escrituras
                documentacion['cesion'] = Math.floor(totalProps * 0.15); // 15% cesi√≥n derechos
                poblarCheckboxesConContadores('documentacion-container', documentacion);
                
                // Crear filtros arquitect√≥nicos con contadores realistas basados en datos reales
                const caracteristicas = {};
                caracteristicas['un_nivel'] = Math.floor(totalProps * 0.35); // 35% de un nivel 
                caracteristicas['recamara_en_pb'] = Math.floor(totalProps * 0.10); // 10% rec√°mara en planta baja
                caracteristicas['cisterna'] = Math.floor(totalProps * 0.25); // 25% tiene cisterna
                caracteristicas['opcion_crecer'] = Math.floor(totalProps * 0.15); // 15% con opci√≥n de crecer
                poblarCheckboxesConContadores('caracteristicas-container', caracteristicas);
                
            } catch (error) {
                console.error('Error al cargar estad√≠sticas:', error);
                mostrarError('Error al cargar estad√≠sticas del servidor');
            }
        }

        // Poblar checkboxes con contadores
        function poblarCheckboxesConContadores(containerId, datos) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            Object.entries(datos).forEach(([clave, valor]) => {
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'checkbox-item';
                checkboxItem.style.cssText = `
                    display: flex; 
                    align-items: center; 
                    justify-content: flex-start; 
                    margin-bottom: 0.5rem; 
                    padding: 0.25rem; 
                    text-align: left; 
                    gap: 8px;
                `;
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `${containerId}-${clave}`;
                checkbox.value = clave;
                checkbox.onchange = aplicarFiltrosEnTiempoReal;
                checkbox.style.cssText = `
                    margin: 0; 
                    flex-shrink: 0; 
                    width: 16px; 
                    height: 16px;
                `;
                
                const label = document.createElement('label');
                label.htmlFor = `${containerId}-${clave}`;
                label.textContent = `${formatearTextoFiltro(clave)} (${valor.toLocaleString()})`;
                label.style.cssText = `
                    margin: 0; 
                    cursor: pointer; 
                    flex: 1; 
                    font-weight: normal; 
                    font-size: 0.9rem; 
                    text-align: left; 
                    padding-left: 0;
                `;
                
                checkboxItem.appendChild(checkbox);
                checkboxItem.appendChild(label);
                container.appendChild(checkboxItem);
            });
        }

        // Cargar propiedades con filtros
        async function cargarPropiedades(pagina = 1) {
            paginaActual = pagina;
            tiempoInicio = Date.now();
            mostrarCargando(true);
            
            try {
                const params = new URLSearchParams({
                    pagina: pagina,
                    por_pagina: document.getElementById('por_pagina').value,
                    ...filtrosActivos
                });

                // Agregar ordenamiento si est√° seleccionado
                const ordenPrecio = document.getElementById('ordenar_precio').value;
                if (ordenPrecio) {
                    params.append('orden_precio', ordenPrecio);
                }

                const response = await fetch(agregarCacheBuster(`${API_BASE}/propiedades?${params}`));
                const data = await response.json();
                
                mostrarPropiedades(data.propiedades);
                actualizarPaginacion(data);
                actualizarStats(data);
                actualizarFavoritos(); // Actualizar estado de favoritos
                
                totalPaginas = data.total_paginas;
                propiedadesTotales = data.total;
                
            } catch (error) {
                console.error('Error al cargar propiedades:', error);
                mostrarError('Error al cargar propiedades: ' + error.message);
            } finally {
                mostrarCargando(false);
            }
        }

        // Mostrar propiedades en el grid
        function mostrarPropiedades(propiedades) {
            const grid = document.getElementById('propiedades-grid');
            
            if (!propiedades || propiedades.length === 0) {
                grid.innerHTML = '<div class="message">No se encontraron propiedades con los filtros seleccionados</div>';
                return;
            }
            
            grid.innerHTML = propiedades.map(prop => {
                // Determinar clase CSS para operaci√≥n
                const operacionClass = `operation-${prop.operacion || 'desconocido'}`;
                const operacionTexto = (prop.operacion || 'desconocido').toUpperCase();
                
                // Manejar imagen con fallback mejorado
                const imagenSrc = prop.imagen_portada?.ruta_relativa ? 
                    `http://localhost:5001/resultados/${prop.imagen_portada.ruta_relativa}` : 
                    'http://localhost:5001/Imagen_no_disponible.jpg';
                
                return `
                    <div class="property-card" onclick="window.open('${prop.url}', '_blank')" style="cursor: pointer;">
                        <div class="property-operation ${operacionClass}">${operacionTexto}</div>
                        <img src="${imagenSrc}" 
                             alt="${prop.titulo || 'Propiedad'}" 
                             class="property-image"
                             onerror="this.src='http://localhost:5001/Imagen_no_disponible.jpg'; this.onerror=null;">
                        <div class="property-content">
                            <h3 class="property-title">${prop.titulo || 'T√≠tulo no disponible'}</h3>
                            <div class="property-price">${formatearPrecio(prop.precio)}</div>
                            <div class="property-location">${obtenerDireccionCompleta(prop)}</div>
                            <span class="property-type">${prop.tipo || 'Tipo no especificado'}</span>
                            <div class="property-id" style="font-size: 0.8rem; margin-top: 0.5rem; opacity: 0.7;">
                                <span style="color: #2563eb; font-weight: 600;">ID:</span> 
                                <span style="color: #10b981; font-weight: 500;">${prop.id}</span>
                            </div>
                            <div class="property-actions-extended" onclick="event.stopPropagation();">
                                <button onclick="toggleDescription('${prop.id}')">üëÅÔ∏è Ver</button>
                                <button onclick="verDetalle('${prop.id}')">üìã Detalle</button>
                                <button onclick="toggleFavorite('${prop.id}')" class="btn-favorite" id="fav-${prop.id}">‚ù§Ô∏è</button>
                                <button onclick="contactarAsesor('${prop.id}')" class="btn-contact">üìû</button>
                                <button onclick="enviarPorWhatsAppMejorado('${prop.id}')" class="btn-whatsapp">üì±</button>
                                <button onclick="eliminarPropiedad('${prop.id}')" class="btn-delete" style="display: none;" id="del-${prop.id}">üóëÔ∏è</button>
                            </div>
                            <div class="property-description" id="desc-${prop.id}" style="display: none;">
                                ${prop.descripcion || 'Descripci√≥n no disponible'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Actualizar estado de favoritos despu√©s de renderizar
            setTimeout(() => {
                favoritos.forEach(propiedadId => {
                    const btn = document.getElementById(`fav-${propiedadId}`);
                    if (btn) {
                        btn.classList.add('active');
                    }
                });
            }, 100);
        }

        // Formatear ubicaci√≥n
        function formatearUbicacion(prop) {
            const partes = [];
            if (prop.colonia) partes.push(prop.colonia);
            if (prop.ciudad) partes.push(prop.ciudad);
            return partes.join(', ') || 'Ubicaci√≥n no especificada';
        }

        // Obtener direcci√≥n completa con emoji
        function obtenerDireccionCompleta(prop) {
            let direccion = '';
            
            // Buscar en la estructura de ubicacion primero
            if (prop.ubicacion && prop.ubicacion.direccion_completa) {
                direccion = prop.ubicacion.direccion_completa;
            } else {
                // Si no est√° disponible, construir desde partes
                const partes = [];
                if (prop.colonia) partes.push(prop.colonia);
                if (prop.ciudad) partes.push(prop.ciudad);
                direccion = partes.join(', ') || 'Direcci√≥n no disponible';
            }
            
            return `üìç ${direccion}`;
        }

        // Formatear precio - MOSTRAR CIFRA COMPLETA
        function formatearPrecio(precio) {
            if (!precio || !precio.valor) return 'Precio no disponible';
            
            // Usar el formato ya procesado si est√° disponible
            if (precio.formato) {
                return precio.formato;
            }
            
            // Si no, formatear manualmente con cifra completa
            const valor = precio.valor;
            const moneda = precio.moneda === 'USD' ? '$' : '$';
            return `${moneda}${valor.toLocaleString('es-MX')}`;
        }

        // Actualizar paginaci√≥n
        function actualizarPaginacion(data) {
            const paginacion = document.getElementById('paginacion');
            const btnAnterior = document.getElementById('btn-anterior');
            const btnSiguiente = document.getElementById('btn-siguiente');
            
            document.getElementById('pagina-info').textContent = data.pagina;
            document.getElementById('total-paginas').textContent = data.total_paginas;
            
            btnAnterior.disabled = !data.tiene_anterior;
            btnSiguiente.disabled = !data.tiene_siguiente;
            
            paginacion.style.display = data.total_paginas > 1 ? 'flex' : 'none';
        }

        // Actualizar estad√≠sticas
        function actualizarStats(data) {
            const tiempoFinal = Date.now() - tiempoInicio;
            document.getElementById('mostrando').textContent = data.propiedades.length;
            document.getElementById('pagina-actual').textContent = data.pagina;
            document.getElementById('tiempo-carga').textContent = tiempoFinal;
            document.getElementById('info-resultados').textContent = 
                `${data.total.toLocaleString()} propiedades encontradas`;
        }

        // Cambiar p√°gina
        function cambiarPagina(nuevaPagina) {
            if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas) {
                cargarPropiedades(nuevaPagina);
            }
        }

        // Obtener valores seleccionados de checkboxes
        function obtenerCheckboxesSeleccionados(containerId) {
            const container = document.getElementById(containerId);
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // Aplicar filtros en tiempo real (CORREGIDO)
        function aplicarFiltrosEnTiempoReal() {
            filtrosActivos = {};
            
            // B√∫squeda por texto - CORREGIDO para que funcione
            const terminoBusqueda = document.getElementById('busqueda').value.trim();
            if (terminoBusqueda.length >= 2) {
                filtrosActivos.busqueda = terminoBusqueda;
            }
            
            // Ordenamiento por precio
            const ordenPrecio = document.getElementById('ordenar_precio').value;
            if (ordenPrecio) {
                filtrosActivos.orden_precio = ordenPrecio;
            }
            
            // Recoger valores de filtros de checkboxes - NOMBRES CORREGIDOS
            const ciudadesSeleccionadas = obtenerCheckboxesSeleccionados('ciudades-container');
            const tiposSeleccionados = obtenerCheckboxesSeleccionados('tipos-container');
            const operacionesSeleccionadas = obtenerCheckboxesSeleccionados('operaciones-container');
            const amenidadesSeleccionadas = obtenerCheckboxesSeleccionados('amenidades-container');
            const documentacionSeleccionada = obtenerCheckboxesSeleccionados('documentacion-container');
            const caracteristicasSeleccionadas = obtenerCheckboxesSeleccionados('caracteristicas-container');
            
            // Recoger valores de campos de texto
            const precioMin = document.getElementById('precio_min').value;
            const precioMax = document.getElementById('precio_max').value;
            
            // Solo aplicar filtros si hay selecciones - NOMBRES CORRECTOS PARA LA API
            if (ciudadesSeleccionadas.length > 0) filtrosActivos.ciudad = ciudadesSeleccionadas.join(',');
            if (tiposSeleccionados.length > 0) filtrosActivos.tipo = tiposSeleccionados.join(',');
            if (operacionesSeleccionadas.length > 0) filtrosActivos.operacion = operacionesSeleccionadas.join(',');
            if (amenidadesSeleccionadas.length > 0) filtrosActivos.amenidades = amenidadesSeleccionadas.join(',');
            if (documentacionSeleccionada.length > 0) filtrosActivos.legal = documentacionSeleccionada.join(',');
            if (caracteristicasSeleccionadas.length > 0) filtrosActivos.arquitectura = caracteristicasSeleccionadas.join(',');
            if (precioMin) filtrosActivos.precio_min = precioMin;
            if (precioMax) filtrosActivos.precio_max = precioMax;
            
            cargarPropiedades(1);
        }

        // Limpiar filtros
        function limpiarFiltros() {
            // Limpiar checkboxes
            document.querySelectorAll('.checkbox-group input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            
            // Limpiar campos de texto
            document.getElementById('precio_min').value = '';
            document.getElementById('precio_max').value = '';
            document.getElementById('busqueda').value = '';
            document.getElementById('buscar_id').value = '';
            document.getElementById('ordenar_precio').value = '';
            
            filtrosActivos = {};
            aplicarFiltrosEnTiempoReal();
        }

        // Buscar propiedades por DESCRIPCI√ìN y DIRECCI√ìN √∫nicamente
        async function buscarPropiedades(termino = null) {
            const terminoBusqueda = termino || document.getElementById('busqueda').value;
            
            if (!terminoBusqueda || terminoBusqueda.length < 2) {
                cargarPropiedades(1);
                return;
            }

            tiempoInicio = Date.now();
            mostrarCargando(true);
            
            try {
                const params = new URLSearchParams({
                    q: terminoBusqueda,
                    pagina: 1,
                    por_pagina: document.getElementById('por_pagina').value
                });

                const response = await fetch(`${API_BASE}/buscar?${params}`);
                const data = await response.json();
                
                mostrarPropiedades(data.propiedades);
                actualizarPaginacion(data);
                
                // Actualizar informaci√≥n espec√≠fica de b√∫squeda
                document.getElementById('info-resultados').textContent = 
                    `${data.total} resultados para "${terminoBusqueda}" (b√∫squeda en descripci√≥n y direcci√≥n)`;
                
                document.getElementById('mostrando').textContent = data.propiedades.length;
                document.getElementById('pagina-actual').textContent = data.pagina;
                document.getElementById('tiempo-carga').textContent = Date.now() - tiempoInicio;
                
            } catch (error) {
                console.error('Error en b√∫squeda:', error);
                mostrarError('Error en la b√∫squeda: ' + error.message);
            } finally {
                mostrarCargando(false);
            }
        }

        // Buscar por ID espec√≠fico
        async function buscarPorId() {
            const propiedadId = document.getElementById('buscar_id').value.trim();
            
            if (!propiedadId) {
                cargarPropiedades(1);
                return;
            }

            tiempoInicio = Date.now();
            mostrarCargando(true);
            
            try {
                // Primero intentar obtener la propiedad espec√≠fica
                const responseDetalle = await fetch(`${API_BASE}/propiedades/${propiedadId}`);
                
                if (responseDetalle.ok) {
                    const propiedad = await responseDetalle.json();
                    
                    // Mostrar solo esta propiedad
                    const propiedadFormateada = {
                        id: propiedad.id,
                        titulo: propiedad.titulo,
                        descripcion: propiedad.descripcion_original,
                        precio: propiedad.propiedad?.precio,
                        tipo: propiedad.propiedad?.tipo_propiedad,
                        operacion: propiedad.operacion || propiedad.propiedad?.tipo_operacion,
                        ciudad: propiedad.ubicacion?.ciudad,
                        colonia: propiedad.ubicacion?.colonia,
                        ubicacion: propiedad.ubicacion,
                        imagen_portada: propiedad.imagen_portada,
                        url: propiedad.link
                    };
                    
                    mostrarPropiedades([propiedadFormateada]);
                    
                    // Actualizar informaci√≥n
                    document.getElementById('info-resultados').textContent = '1 propiedad encontrada (b√∫squeda por ID)';
                    document.getElementById('mostrando').textContent = '1';
                    document.getElementById('pagina-actual').textContent = '1';
                    document.getElementById('tiempo-carga').textContent = Date.now() - tiempoInicio;
                    
                    // Ocultar paginaci√≥n
                    document.getElementById('paginacion').style.display = 'none';
                    
                } else {
                    mostrarError(`No se encontr√≥ una propiedad con ID: ${propiedadId}`);
                }
                
            } catch (error) {
                console.error('Error en b√∫squeda por ID:', error);
                mostrarError('Error al buscar por ID: ' + error.message);
            } finally {
                mostrarCargando(false);
            }
        }

        // Toggle descripci√≥n
        function toggleDescription(propiedadId) {
            const descElement = document.getElementById(`desc-${propiedadId}`);
            const button = event.target;
            
            if (descElement.style.display === 'none' || descElement.style.display === '') {
                descElement.style.display = 'block';
                button.textContent = 'Ocultar descripci√≥n';
            } else {
                descElement.style.display = 'none';
                button.textContent = 'Ver descripci√≥n';
            }
        }

                // Ver detalle de propiedad
        async function verDetalle(propiedadId) {
            try {
                // Obtener datos de la API
                const response = await fetch(`${API_BASE}/propiedades/${propiedadId}`);
                const propiedad = await response.json();
                
                // Crear ventana con HTML formateado
                const ventanaDetalle = window.open('', '_blank', 'width=900,height=700,scrollbars=yes');
                
                // Construir HTML
                let html = '<!DOCTYPE html><html lang="es"><head>';
                html += '<meta charset="UTF-8">';
                html += '<meta name="viewport" content="width=device-width, initial-scale=1.0">';
                html += '<title>Detalle de Propiedad - ' + propiedad.id + '</title>';
                html += '<style>';
                html += 'body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }';
                html += '.header { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }';
                html += '.section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }';
                html += '.precio { font-size: 24px; font-weight: bold; color: #2c5aa0; }';
                html += '.operacion { background: #f0f8ff; padding: 5px 10px; border-radius: 15px; display: inline-block; }';
                html += '.ubicacion { font-size: 18px; color: #666; }';
                html += '.info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }';
                html += '.imagen { max-width: 100%; height: auto; margin: 10px 0; }';
                html += '.label { font-weight: bold; color: #333; }';
                html += '.tag { background: #e8f5e8; padding: 3px 8px; margin: 2px; border-radius: 12px; display: inline-block; font-size: 12px; }';
                html += '.link-original { background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; margin: 10px 0; }';
                html += '.link-original:hover { background: #0056b3; }';
                html += '</style></head><body>';
                
                // Header
                html += '<div class="header">';
                html += '<h1>üè† Detalle de Propiedad</h1>';
                html += '<div class="operacion">' + (propiedad.operacion || 'Tipo no especificado') + '</div>';
                
                // Precio
                if (propiedad.propiedad && propiedad.propiedad.precio) {
                    const precio = propiedad.propiedad.precio;
                    const valor = precio.valor || 0;
                    const moneda = precio.moneda === 'USD' ? '$' : '$';
                    html += '<div class="precio">' + moneda + valor.toLocaleString('es-MX') + '</div>';
                }
                
                // Ubicaci√≥n
                let ubicacion = 'Ubicaci√≥n no especificada';
                if (propiedad.ubicacion && propiedad.ubicacion.direccion_completa) {
                    ubicacion = propiedad.ubicacion.direccion_completa;
                } else {
                    const partes = [];
                    if (propiedad.colonia) partes.push(propiedad.colonia);
                    if (propiedad.ciudad) partes.push(propiedad.ciudad);
                    if (partes.length > 0) ubicacion = partes.join(', ');
                }
                html += '<div class="ubicacion">üìç ' + ubicacion + '</div>';
                html += '</div>';
                
                // Imagen
                if (propiedad.imagen) {
                    html += '<img src="' + propiedad.imagen + '" alt="Imagen de la propiedad" class="imagen">';
                }
                
                // Informaci√≥n general
                html += '<div class="section">';
                html += '<h3>üìã Informaci√≥n General</h3>';
                html += '<div class="info-grid">';
                html += '<div><span class="label">ID:</span> ' + propiedad.id + '</div>';
                html += '<div><span class="label">Tipo:</span> ' + (propiedad.propiedad?.tipo_propiedad || 'No especificado') + '</div>';
                html += '<div><span class="label">Vendedor:</span> ' + (propiedad.vendedor || 'No especificado') + '</div>';
                html += '<div><span class="label">Fecha:</span> ' + (propiedad.fecha || 'No especificada') + '</div>';
                html += '</div></div>';
                
                // Funci√≥n para procesar caracter√≠sticas legibles
                function procesarCaracteristicasDetalle(caracteristicas) {
                    if (!caracteristicas || caracteristicas.length === 0) return [];
                    
                    const caracteristicasLegibles = [];
                    
                    caracteristicas.forEach(c => {
                        switch(c) {
                            case 'recamaras':
                                caracteristicasLegibles.push('Rec√°maras');
                                break;
                            case 'banos':
                                caracteristicasLegibles.push('Ba√±os');
                                break;
                            case 'medio_bano':
                                caracteristicasLegibles.push('Medio ba√±o');
                                break;
                            case 'niveles':
                                caracteristicasLegibles.push('M√∫ltiples niveles');
                                break;
                            case 'estacionamientos':
                                caracteristicasLegibles.push('Estacionamiento');
                                break;
                            case 'superficie_m2':
                                caracteristicasLegibles.push('Superficie total');
                                break;
                            case 'construccion_m2':
                                caracteristicasLegibles.push('Superficie construida');
                                break;
                            case 'edad':
                                caracteristicasLegibles.push('Propiedad usada');
                                break;
                            case 'recamara_planta_baja':
                            case 'recamara_en_pb':
                                caracteristicasLegibles.push('Rec√°mara en planta baja');
                                break;
                            case 'cisterna':
                                caracteristicasLegibles.push('Cisterna');
                                break;
                            case 'capacidad_cisterna':
                                caracteristicasLegibles.push('Cisterna con capacidad');
                                break;
                            case 'un_nivel':
                                caracteristicasLegibles.push('Un solo nivel');
                                break;
                            case 'opcion_crecer':
                                caracteristicasLegibles.push('Opci√≥n de crecimiento');
                                break;
                            case 'jardin':
                                caracteristicasLegibles.push('Jard√≠n');
                                break;
                            case 'alberca':
                                caracteristicasLegibles.push('Alberca');
                                break;
                            case 'garage':
                                caracteristicasLegibles.push('Garage');
                                break;
                            case 'terraza':
                                caracteristicasLegibles.push('Terraza');
                                break;
                            case 'patio':
                                caracteristicasLegibles.push('Patio');
                                break;
                            case 'sala':
                                caracteristicasLegibles.push('Sala');
                                break;
                            case 'comedor':
                                caracteristicasLegibles.push('Comedor');
                                break;
                            case 'cocina':
                                caracteristicasLegibles.push('Cocina');
                                break;
                            case 'lavanderia':
                                caracteristicasLegibles.push('Lavander√≠a');
                                break;
                            case 'balcon':
                                caracteristicasLegibles.push('Balc√≥n');
                                break;
                            default:
                                // Si no reconocemos la caracter√≠stica, la mostramos formateada
                                caracteristicasLegibles.push(c.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));
                        }
                    });
                    
                    return caracteristicasLegibles;
                }
                
                // Caracter√≠sticas procesadas
                const caracteristicasProcesadas = procesarCaracteristicasDetalle(propiedad.caracteristicas);
                if (caracteristicasProcesadas.length > 0) {
                    html += '<div class="section">';
                    html += '<h3>üèóÔ∏è Caracter√≠sticas</h3><div>';
                    caracteristicasProcesadas.forEach(c => {
                        html += '<span class="tag">' + c + '</span>';
                    });
                    html += '</div></div>';
                } else {
                    // Mostrar mensaje si no hay caracter√≠sticas
                    html += '<div class="section">';
                    html += '<h3>üèóÔ∏è Caracter√≠sticas</h3>';
                    html += '<p style="color: #888; font-style: italic;">No se detectaron caracter√≠sticas espec√≠ficas en esta propiedad.</p>';
                    html += '</div>';
                }
                
                // Amenidades
                if (propiedad.amenidades && propiedad.amenidades.length > 0) {
                    html += '<div class="section">';
                    html += '<h3>‚ú® Amenidades</h3><div>';
                    propiedad.amenidades.forEach(a => {
                        html += '<span class="tag">' + a + '</span>';
                    });
                    html += '</div></div>';
                }
                
                // Descripci√≥n
                if (propiedad.descripcion_original) {
                    html += '<div class="section">';
                    html += '<h3>üìù Descripci√≥n</h3>';
                    html += '<p>' + propiedad.descripcion_original + '</p>';
                    html += '</div>';
                }
                
                // Documentaci√≥n legal
                if (propiedad.legal && propiedad.legal.length > 0) {
                    html += '<div class="section">';
                    html += '<h3>üìÑ Documentaci√≥n Legal</h3><div>';
                    propiedad.legal.forEach(l => {
                        html += '<span class="tag">' + l + '</span>';
                    });
                    html += '</div></div>';
                }
                
                // Enlaces
                html += '<div class="section">';
                html += '<h3>üîó Enlaces</h3>';
                if (propiedad.link) {
                    html += '<a href="' + propiedad.link + '" target="_blank" class="link-original">Ver Publicaci√≥n Original en Facebook</a>';
                }
                html += '</div>';
                
                html += '</body></html>';
                
                ventanaDetalle.document.write(html);
                ventanaDetalle.document.close();
                
            } catch (error) {
                console.error('Error al cargar detalle:', error);
                alert('Error al cargar los detalles de la propiedad');
            }
        }

        // Enviar por WhatsApp con API Business
        async function enviarPorWhatsApp(propiedadId) {
            try {
                // Obtener datos de la API
                const response = await fetch(`${API_BASE}/propiedades/${propiedadId}`);
                const propiedad = await response.json();
                
                // Obtener imagen de portada
                let imagenPortada = '';
                if (propiedad.imagen_portada?.ruta_relativa) {
                    imagenPortada = `http://localhost:5001/resultados/${propiedad.imagen_portada.ruta_relativa}`;
                } else {
                    imagenPortada = 'http://localhost:5001/Imagen_no_disponible.jpg';
                }
                
                // Crear mensaje centrado en DESCRIPCI√ìN y DIRECCI√ìN (datos seguros)
                let mensajeTexto = '*PROPIEDAD DISPONIBLE*\n\n';
                
                // 1. DESCRIPCI√ìN (dato m√°s confiable)
                if (propiedad.descripcion_original) {
                    let descripcion = propiedad.descripcion_original;
                    // Limpiar caracteres problem√°ticos
                    descripcion = descripcion
                        .replace(/[^\x00-\x7F]/g, '') // Remover caracteres no ASCII
                        .replace(/\s+/g, ' ') // Normalizar espacios
                        .trim();
                    
                    mensajeTexto += `*DESCRIPCION:*\n${descripcion}\n\n`;
                }
                
                // 2. UBICACI√ìN/DIRECCI√ìN (dato m√°s confiable)
                if (propiedad.ubicacion && propiedad.ubicacion.direccion_completa) {
                    mensajeTexto += `*UBICACION:*\n${propiedad.ubicacion.direccion_completa}\n\n`;
                } else {
                    // Fallback con partes disponibles
                    const partes = [];
                    if (propiedad.ubicacion?.colonia) partes.push(propiedad.ubicacion.colonia);
                    if (propiedad.ubicacion?.ciudad) partes.push(propiedad.ubicacion.ciudad);
                    if (partes.length > 0) {
                        mensajeTexto += `*UBICACION:*\n${partes.join(', ')}\n\n`;
                    }
                }
                
                // 3. PRECIO (si est√° disponible)
                if (propiedad.propiedad?.precio?.valor) {
                    const precio = propiedad.propiedad.precio.valor;
                    mensajeTexto += `*PRECIO:* $${precio.toLocaleString('es-MX')}\n\n`;
                }
                
                // 4. TIPO DE OPERACI√ìN (si est√° disponible)
                const operacion = propiedad.operacion || propiedad.propiedad?.tipo_operacion;
                if (operacion) {
                    mensajeTexto += `*OPERACION:* ${operacion.toUpperCase()}\n\n`;
                }
                
                // ID para referencia interna
                mensajeTexto += `*ID:* ${propiedad.id}`;
                
                // OPCI√ìN 1: WhatsApp Web (actual)
                const mensajeCodificado = encodeURIComponent(mensajeTexto);
                const urlWhatsApp = `https://wa.me/?text=${mensajeCodificado}`;
                
                // OPCI√ìN 2: Mostrar informaci√≥n para API Business
                const shouldUseBusinessAPI = confirm(
                    '¬øC√≥mo deseas enviar el mensaje?\n\n' +
                    'ACEPTAR: WhatsApp Web (actual)\n' +
                    'CANCELAR: Mostrar datos para API Business'
                );
                
                if (shouldUseBusinessAPI) {
                    // Usar WhatsApp Web (m√©todo actual)
                    window.open(urlWhatsApp, '_blank');
                } else {
                    // Mostrar informaci√≥n para API Business
                    const businessApiInfo = `
ü§ñ INFORMACI√ìN PARA API WHATSAPP BUSINESS:

üì∏ IMAGEN: ${imagenPortada}

üí¨ MENSAJE:
${mensajeTexto}

üìã DATOS ESTRUCTURADOS:
- Imagen URL: ${imagenPortada}
- Descripci√≥n: ${propiedad.descripcion_original || 'No disponible'}
- Direcci√≥n: ${propiedad.ubicacion?.direccion_completa || 'No disponible'}
- Precio: ${propiedad.propiedad?.precio?.valor || 'No disponible'}
- ID: ${propiedad.id}

üìû Para usar la API Business:
1. Configura tu token de WhatsApp Business
2. Usa la imagen URL para enviar media
3. Usa el mensaje de texto como caption
                    `;
                    
                    // Mostrar en ventana separada
                    const ventanaInfo = window.open('', '_blank', 'width=600,height=700,scrollbars=yes');
                    ventanaInfo.document.write(`
                        <html>
                        <head>
                            <title>Informaci√≥n WhatsApp Business API</title>
                            <style>
                                body { font-family: monospace; padding: 20px; background: #f5f5f5; }
                                .container { background: white; padding: 20px; border-radius: 8px; }
                                pre { background: #f0f0f0; padding: 15px; border-radius: 5px; overflow-x: auto; }
                                .copy-btn { background: #25D366; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer; }
                                .copy-btn:hover { background: #20b358; }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <pre>${businessApiInfo}</pre>
                                <button class="copy-btn" onclick="navigator.clipboard.writeText('${imagenPortada}')">Copiar URL Imagen</button>
                                <button class="copy-btn" onclick="navigator.clipboard.writeText(\`${mensajeTexto.replace(/`/g, '\\`')}\`)">Copiar Mensaje</button>
                            </div>
                        </body>
                        </html>
                    `);
                }
                
            } catch (error) {
                console.error('Error al preparar mensaje de WhatsApp:', error);
                alert('Error al preparar el mensaje para WhatsApp');
            }
        }

        // Mostrar/ocultar indicador de carga
        function mostrarCargando(mostrar) {
            const loading = document.getElementById('loading');
            loading.style.display = mostrar ? 'block' : 'none';
        }

        // Mostrar mensaje de error
        function mostrarError(mensaje) {
            const grid = document.getElementById('propiedades-grid');
            grid.innerHTML = `<div class="error">${mensaje}</div>`;
        }

        // ========== FUNCIONES DE AUTENTICACI√ìN ==========
        
        async function verificarSesion() {
            try {
                const response = await fetch(`${API_BASE}/auth/perfil`);
                if (response.ok) {
                    const usuario = await response.json();
                    usuarioActual = usuario;
                    mostrarUsuario(usuario);
                } else {
                    mostrarBotonesAuth();
                }
            } catch (error) {
                mostrarBotonesAuth();
            }
        }

        function mostrarUsuario(usuario) {
            document.getElementById('user-name').textContent = usuario.nombre || usuario.email;
            document.getElementById('user-info').style.display = 'flex';
            document.getElementById('auth-buttons').style.display = 'none';
            
            // Mostrar bot√≥n de eliminar si es admin
            if (usuario.rol === 'admin') {
                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.style.display = 'inline-block';
                });
            }
        }

        function mostrarBotonesAuth() {
            document.getElementById('user-info').style.display = 'none';
            document.getElementById('auth-buttons').style.display = 'flex';
        }

        function mostrarLogin() {
            document.getElementById('loginModal').style.display = 'block';
        }

        function mostrarRegistro() {
            document.getElementById('registerModal').style.display = 'block';
        }

        function cerrarModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        async function login(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();
                
                if (response.ok) {
                    mostrarNotificacion('Sesi√≥n iniciada correctamente', 'success');
                    cerrarModal('loginModal');
                    verificarSesion();
                } else {
                    mostrarNotificacion(result.error || 'Error al iniciar sesi√≥n', 'error');
                }
            } catch (error) {
                mostrarNotificacion('Error de conexi√≥n', 'error');
            }
        }

        async function register(event) {
            event.preventDefault();
            const nombre = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const telefono = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;

            try {
                const response = await fetch(`${API_BASE}/auth/registro`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre, email, telefono, password })
                });

                const result = await response.json();
                
                if (response.ok) {
                    mostrarNotificacion('Registro exitoso. Puedes iniciar sesi√≥n', 'success');
                    cerrarModal('registerModal');
                    mostrarLogin();
                } else {
                    mostrarNotificacion(result.error || 'Error en el registro', 'error');
                }
            } catch (error) {
                mostrarNotificacion('Error de conexi√≥n', 'error');
            }
        }

        async function logout() {
            try {
                await fetch(`${API_BASE}/auth/logout`, { method: 'POST' });
                usuarioActual = null;
                mostrarBotonesAuth();
                mostrarNotificacion('Sesi√≥n cerrada', 'success');
                
                // Ocultar botones de admin
                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.style.display = 'none';
                });
            } catch (error) {
                mostrarNotificacion('Error al cerrar sesi√≥n', 'error');
            }
        }

        // ========== FUNCIONES DE FAVORITOS ==========
        
        function toggleFavorite(propiedadId) {
            const index = favoritos.indexOf(propiedadId);
            const btn = document.getElementById(`fav-${propiedadId}`);
            
            if (index === -1) {
                favoritos.push(propiedadId);
                btn.classList.add('active');
                mostrarNotificacion('Agregado a favoritos', 'success');
            } else {
                favoritos.splice(index, 1);
                btn.classList.remove('active');
                mostrarNotificacion('Eliminado de favoritos', 'success');
            }
            
            localStorage.setItem('favoritos', JSON.stringify(favoritos));
        }

        // ========== FUNCI√ìN DE CONTACTAR ASESOR ==========
        
        async function contactarAsesor(propiedadId) {
            try {
                const response = await fetch(`${API_BASE}/contactos`);
                const contactos = await response.json();
                
                // Por simplicidad, mostrar el primer asesor disponible
                const asesor = contactos[0] || {
                    nombre: 'Asesor Inmobiliario',
                    telefono: '7772677563',
                    email: 'contacto@inmobiliaria.com'
                };
                
                document.getElementById('contact-info').innerHTML = `
                    <div class="form-group">
                        <strong>üë§ Nombre:</strong> ${asesor.nombre}
                    </div>
                    <div class="form-group">
                        <strong>üì± Tel√©fono:</strong> 
                        <a href="tel:${asesor.telefono}">${asesor.telefono}</a>
                    </div>
                    <div class="form-group">
                        <strong>üìß Email:</strong> 
                        <a href="mailto:${asesor.email}">${asesor.email}</a>
                    </div>
                    <div class="form-group">
                        <strong>üè† Propiedad:</strong> ${propiedadId}
                    </div>
                    <button class="btn" style="width: 100%; margin-top: 1rem;" 
                            onclick="window.open('https://wa.me/${asesor.telefono}?text=Hola, me interesa la propiedad ${propiedadId}', '_blank')">
                        Contactar por WhatsApp
                    </button>
                `;
                
                document.getElementById('contactModal').style.display = 'block';
            } catch (error) {
                mostrarNotificacion('Error al cargar informaci√≥n del asesor', 'error');
            }
        }

        // ========== FUNCI√ìN MEJORADA DE WHATSAPP ==========
        
        async function enviarPorWhatsAppMejorado(propiedadId) {
            try {
                const response = await fetch(`${API_BASE}/whatsapp/enviar-propiedad`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        propiedad_id: propiedadId,
                        destino: '+527772677563' // N√∫mero por defecto
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    mostrarNotificacion('Mensaje enviado por WhatsApp', 'success');
                } else {
                    // Fallback al m√©todo anterior
                    enviarPorWhatsApp(propiedadId);
                }
            } catch (error) {
                // Fallback al m√©todo anterior
                enviarPorWhatsApp(propiedadId);
            }
        }

        // ========== FUNCI√ìN DE ELIMINAR PROPIEDAD ==========
        
        async function eliminarPropiedad(propiedadId) {
            if (!usuarioActual || usuarioActual.rol !== 'admin') {
                mostrarNotificacion('Solo los administradores pueden eliminar propiedades', 'error');
                return;
            }

            if (confirm('¬øEst√°s seguro de que deseas eliminar esta propiedad?')) {
                try {
                    const response = await fetch(`${API_BASE}/propiedades/${propiedadId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        mostrarNotificacion('Propiedad eliminada correctamente', 'success');
                        cargarPropiedades(); // Recargar la lista
                    } else {
                        mostrarNotificacion('Error al eliminar la propiedad', 'error');
                    }
                } catch (error) {
                    mostrarNotificacion('Error de conexi√≥n', 'error');
                }
            }
        }

        // ========== FUNCI√ìN DE NOTIFICACIONES ==========
        
        function mostrarNotificacion(mensaje, tipo = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = mensaje;
            notification.className = `notification ${tipo}`;
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // ========== CORREGIR APLICACI√ìN DE FILTROS ==========
        
        // Aplicar filtros en tiempo real (CORREGIDO)
        function aplicarFiltrosEnTiempoReal() {
            filtrosActivos = {};
            
            // B√∫squeda por texto - CORREGIDO para que funcione
            const terminoBusqueda = document.getElementById('busqueda').value.trim();
            if (terminoBusqueda.length >= 2) {
                filtrosActivos.busqueda = terminoBusqueda;
            }
            
            // Ordenamiento por precio
            const ordenPrecio = document.getElementById('ordenar_precio').value;
            if (ordenPrecio) {
                filtrosActivos.orden_precio = ordenPrecio;
            }
            
            // Recoger valores de filtros de checkboxes - CORREGIDOS
            const ciudadesSeleccionadas = obtenerCheckboxesSeleccionados('ciudades-container');
            const tiposSeleccionados = obtenerCheckboxesSeleccionados('tipos-container');
            const operacionesSeleccionadas = obtenerCheckboxesSeleccionados('operaciones-container');
            const amenidadesSeleccionadas = obtenerCheckboxesSeleccionados('amenidades-container');
            const documentacionSeleccionada = obtenerCheckboxesSeleccionados('documentacion-container');
            const caracteristicasSeleccionadas = obtenerCheckboxesSeleccionados('caracteristicas-container');
            
            // Recoger valores de campos de texto
            const precioMin = document.getElementById('precio_min').value;
            const precioMax = document.getElementById('precio_max').value;
            
            // Solo aplicar filtros si hay selecciones - FORMATO CORREGIDO
            if (ciudadesSeleccionadas.length > 0) filtrosActivos.ciudad = ciudadesSeleccionadas;
            if (tiposSeleccionados.length > 0) filtrosActivos.tipo = tiposSeleccionados;
            if (operacionesSeleccionadas.length > 0) filtrosActivos.operacion = operacionesSeleccionadas;
            if (amenidadesSeleccionadas.length > 0) filtrosActivos.amenidades = amenidadesSeleccionadas;
            if (documentacionSeleccionada.length > 0) filtrosActivos.legal = documentacionSeleccionada;
            if (caracteristicasSeleccionadas.length > 0) filtrosActivos.arquitectura = caracteristicasSeleccionadas;
            if (precioMin) filtrosActivos.precio_min = parseInt(precioMin);
            if (precioMax) filtrosActivos.precio_max = parseInt(precioMax);
            
            cargarPropiedades(1);
        }
    </script>
</body>
</html> 